#!/bin/sh
# color - Change the desktop environment color scheme

COLOR_SCHEME="$(gsettings get org.gnome.desktop.interface color-scheme)"
COLOR_SCHEME=${COLOR_SCHEME#"'prefer-"}
COLOR_SCHEME=${COLOR_SCHEME%"'"}

setScheme() {
  [ "$1" = "$COLOR_SCHEME" ] && exit 0 # $1 is the active color scheme already
  [ "$1" = dark ] && old=light || old=dark

  gsettings set org.gnome.desktop.interface color-scheme prefer-"$1"

  sed -i "s/$old-colors.css/$1-colors.css/" "$XDG_CONFIG_HOME"/waybar/style.css
  sed -i "s/$old-colors/$1-colors/" "$XDG_CONFIG_HOME"/sway/config
  swaymsg reload

  sed -i "s/@theme \"$old\"/@theme \"$1\"/" "$XDG_CONFIG_HOME"/rofi/config.rasi

  # Terminal and shell
  kitten themes --reload-in=all "Gruvbox $(echo "$1" | tr dl DL) Hard"
  sed -i "s/--theme=gruvbox-$old/--theme=gruvbox-$1/" "$(bat --config-file)"

  sed -i "s/background = '$old'/background = '$1'/" "$XDG_CONFIG_HOME"/nvim/lua/options.lua
  for pipe in /tmp/*-nvim.pipe
  do
    nvim --server "$pipe" --remote-send "<cmd>set bg=$1<cr>" > /dev/null 2>&1
  done
}

case "$1" in # parse invocation argument
  dark) setScheme dark ;;
  light) setScheme light ;;
  toggle) { [ "$COLOR_SCHEME" = dark ] && setScheme light; } || setScheme dark ;;
  auto)
    DAWN=06
    SUNSET=20
    now=$(date +%H)

    if _=$((now > DAWN && now < SUNSET))
    then
      setScheme light
    else
      setScheme dark
    fi
    ;;
  *)
    echo "Usage: $(basename "$0") (dark|light|toggle|auto)"
    echo "Current color scheme: $COLOR_SCHEME"
    ;;
esac
